<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡∏°‡∏µ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• (‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        
        /* Menu Bar ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        .navbar { background: #1e293b; color: white; padding: 15px; text-align: center; font-size: 18px; font-weight: bold; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ */
        .nav-tabs { display: flex; justify-content: space-around; background: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .nav-btn { border: none; background: none; font-family: 'Sarabun'; font-size: 14px; color: #64748b; cursor: pointer; padding: 5px 10px; border-radius: 20px; transition: 0.2s; }
        .nav-btn.active { background: var(--primary); color: white; }
        .nav-btn i { display: block; font-size: 20px; margin-bottom: 3px; }

        /* Container */
        .container { max-width: 800px; margin: auto; padding: 0 15px; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Cards & Inputs */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 16px; font-family: 'Sarabun'; }
        button { cursor: pointer; font-weight: bold; border: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; padding: 5px 10px; font-size: 14px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: #f1f5f9; }

        /* Receipt (Hidden by default) */
        #receipt-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto; padding: 20px 0;
        }
        #receipt-paper {
            background: white; width: 350px; padding: 30px; box-sizing: border-box; margin: auto; position: relative;
        }
    </style>
</head>
<body>

    <div class="navbar">üêª ‡∏´‡∏°‡∏µ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á (PRO)</div>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="switchPage('pos')"><i class="fas fa-calculator"></i>‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</button>
        <button class="nav-btn" onclick="switchPage('dashboard')"><i class="fas fa-chart-pie"></i>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
        <button class="nav-btn" onclick="switchPage('customers')"><i class="fas fa-users"></i>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
        <button class="nav-btn" onclick="switchPage('reports')"><i class="fas fa-file-export"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    </div>

    <div class="container">
        <div id="pos" class="page active">
            <div class="card">
                <h3>üõí ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏¢‡∏∞</h3>
                
                <div style="display: flex; gap: 5px;">
                    <input type="tel" id="cust-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà)">
                    <button class="btn-primary" style="width: 60px;" onclick="findCustomer()"><i class="fas fa-search"></i></button>
                </div>
                <div id="cust-status" style="font-size: 14px; color: #666; margin-bottom: 10px;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>

                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">

                <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏¢‡∏∞:</label>
                <select id="item-type">
                    <option value="‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏•‡∏±‡∏á">‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏•‡∏±‡∏á</option>
                    <option value="‡∏Ç‡∏ß‡∏î‡πÉ‡∏™ (PET)">‡∏Ç‡∏ß‡∏î‡πÉ‡∏™ (PET)</option>
                    <option value="‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°">‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°</option>
                    <option value="‡πÄ‡∏´‡∏•‡πá‡∏Å">‡πÄ‡∏´‡∏•‡πá‡∏Å</option>
                    <option value="‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏£‡∏ß‡∏°">‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏£‡∏ß‡∏°</option>
                    <option value="‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß">‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß</option>
                    <option value="‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á">‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á</option>
                </select>

                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;"><label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.):</label><input type="number" id="item-weight" placeholder="0.0"></div>
                    <div style="flex: 1;"><label>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢:</label><input type="number" id="item-price" placeholder="0.0"></div>
                </div>
                <button class="btn-success" onclick="addItem()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            </div>

            <div class="card" id="cart-section" style="display:none;">
                <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</h3>
                <table id="cart-table">
                    <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏ô‡∏ô.</th><th>‡∏£‡∏ß‡∏°</th><th>‡∏•‡∏ö</th></tr></thead>
                    <tbody></tbody>
                </table>
                <div style="text-align: right; margin-top: 15px; font-size: 20px; font-weight: bold; color: var(--primary);">
                    ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span id="grand-total">0.00</span> ‡∏ö‡∏≤‡∏ó
                </div>
                <button class="btn-primary" style="margin-top: 15px;" onclick="saveOrder()">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
            </div>
        </div>

        <div id="dashboard" class="page">
            <div class="card">
                <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                <h1 id="dash-sales" style="color: var(--primary); margin: 10px 0;">0 ‡∏ö‡∏≤‡∏ó</h1>
                <p>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°: <span id="dash-weight">0</span> ‡∏Å‡∏Å.</p>
                <p>‡∏•‡∏î‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô: <span id="dash-co2">0</span> kgCO‚ÇÇ</p>
                <button class="btn-primary" onclick="loadDashboard()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>

        <div id="customers" class="page">
            <div class="card">
                <h3>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Top 20)</h3>
                <button class="btn-primary" onclick="loadCustomers()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <table style="margin-top: 10px;">
                    <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°</th></tr></thead>
                    <tbody id="cust-list"></tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="page">
            <div class="card">
                <h3>üìë ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
                <button class="btn-success" onclick="exportExcel()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
                <div style="overflow-x: auto; margin-top: 10px;">
                    <table id="report-table">
                        <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏ö‡∏≤‡∏ó</th></tr></thead>
                        <tbody id="trans-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="receipt-modal">
        <div id="receipt-paper">
            <div style="text-align: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 10px;">
                <h2 style="margin:0; color:#2563eb;">‚ôªÔ∏è ‡∏´‡∏°‡∏µ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á</h2>
                <p style="margin:5px 0; font-size:14px;">‡πÇ‡∏ó‡∏£. 081-234-5678</p>
            </div>
            <p style="font-size:14px;"><b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> <span id="rc-name">-</span></p>
            <p style="font-size:14px;"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> <span id="rc-date">-</span></p>
            <table style="width:100%; font-size:14px; border-top:1px solid #eee;">
                <thead><tr><th style="background:white;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="background:white; text-align:right;">‡∏ö‡∏≤‡∏ó</th></tr></thead>
                <tbody id="rc-body"></tbody>
            </table>
            <div style="text-align:right; font-size:20px; font-weight:bold; margin-top:10px; border-top:2px solid #2563eb; padding-top:5px;">
                ‡∏£‡∏ß‡∏°: <span id="rc-total">0.00</span>
            </div>
            <div style="text-align:center; font-size:12px; color:#888; margin-top:20px;">
                ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÇ‡∏•‡∏Å‡∏•‡∏î‡∏Ç‡∏¢‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üêª
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-danger" onclick="document.getElementById('receipt-modal').style.display='none'">‡∏õ‡∏¥‡∏î</button>
                <button class="btn-primary" onclick="downloadImage()">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // const firebaseConfig = {
  apiKey: "AIzaSyBPKWKDSatPSVvBbpWG71Yi5-7lmret4PQ",
  authDomain: "mheerecycle.firebaseapp.com",
  projectId: "mheerecycle",
  storageBucket: "mheerecycle.firebasestorage.app",
  messagingSenderId: "1027251878904",
  appId: "1:1027251878904:web:5b4dd51fc3af8d0b6ef40d",
  measurementId: "G-DK4Z0B4H3R"
};
        // ==========================================
        const firebaseConfig = {
            // ‡πÄ‡∏≠‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Firebase ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
            // apiKey: "AIzaSyD...",
            // authDomain: "...",
            // ...
        };
        // ==========================================

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
        let db;
        let cart = [];
        let currentCust = null;

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        function initSystem() {
            if (!firebaseConfig.apiKey) {
                alert("‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà Firebase Config ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î!");
                return;
            }
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("Database Connected");
            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + err.message);
            }
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        initSystem();

        // --- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ---
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤
            if(pageId === 'dashboard') loadDashboard();
            if(pageId === 'customers') loadCustomers();
            if(pageId === 'reports') loadTransactions();
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
        function addItem() {
            const type = document.getElementById('item-type').value;
            const weight = parseFloat(document.getElementById('item-weight').value);
            const price = parseFloat(document.getElementById('item-price').value);

            if (!weight || !price) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤"); return; }

            cart.push({ type, weight, price, total: weight * price });
            renderCart();
            document.getElementById('item-weight').value = '';
        }

        function renderCart() {
            const tbody = document.querySelector('#cart-table tbody');
            tbody.innerHTML = '';
            let sum = 0;
            cart.forEach((item, index) => {
                sum += item.total;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.type}</td>
                        <td>${item.weight}</td>
                        <td>${item.total.toFixed(2)}</td>
                        <td><button class="btn-danger" onclick="cart.splice(${index}, 1); renderCart()">X</button></td>
                    </tr>`;
            });
            document.getElementById('grand-total').innerText = sum.toFixed(2);
            document.getElementById('cart-section').style.display = cart.length ? 'block' : 'none';
        }

        // --- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ---
        function findCustomer() {
            if(!db) return alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const phone = document.getElementById('cust-phone').value;
            if(!phone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");

            db.collection("customers").where("phone", "==", phone).get().then(snap => {
                if(!snap.empty) {
                    const doc = snap.docs[0];
                    currentCust = { id: doc.id, ...doc.data() };
                    document.getElementById('cust-status').innerHTML = `<span style="color:green">‚úÖ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤: ${currentCust.name}</span>`;
                } else {
                    if(confirm("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏´‡∏°?")) {
                        const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà:");
                        if(name) {
                            const newObj = { name, phone, totalSales: 0, totalCo2: 0, joined: new Date().toISOString() };
                            db.collection("customers").add(newObj).then(docRef => {
                                currentCust = { id: docRef.id, ...newObj };
                                document.getElementById('cust-status').innerHTML = `<span style="color:blue">üÜï ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà: ${name}</span>`;
                            });
                        }
                    }
                }
            }).catch(err => alert("Error: " + err.message));
        }

        // --- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
        function saveOrder() {
            if(!cart.length) return;
            if(!db) return alert("Error: DB not connected");

            const total = cart.reduce((a,b) => a + b.total, 0);
            const totalWeight = cart.reduce((a,b) => a + b.weight, 0);
            const totalCo2 = totalWeight * 1.5; // ‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏°‡∏°‡∏ï‡∏¥

            const orderData = {
                date: new Date().toISOString(),
                customerName: currentCust ? currentCust.name : '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
                customerId: currentCust ? currentCust.id : 'guest',
                items: cart,
                total, totalWeight, totalCo2
            };

            // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Transaction
            db.collection("transactions").add(orderData).then(() => {
                // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                if(currentCust) {
                    db.collection("customers").doc(currentCust.id).update({
                        totalSales: firebase.firestore.FieldValue.increment(total),
                        totalCo2: firebase.firestore.FieldValue.increment(totalCo2)
                    });
                }
                
                // 3. ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                showReceipt(orderData);
                
                // 4. Reset
                cart = [];
                currentCust = null;
                document.getElementById('cust-phone').value = '';
                document.getElementById('cust-status').innerText = '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                renderCart();
            }).catch(err => alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message));
        }

        // --- ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ---
        function showReceipt(data) {
            document.getElementById('receipt-modal').style.display = 'flex';
            document.getElementById('rc-name').innerText = data.customerName;
            document.getElementById('rc-date').innerText = new Date().toLocaleString('th-TH');
            document.getElementById('rc-total').innerText = data.total.toFixed(2);
            
            const tbody = document.getElementById('rc-body');
            tbody.innerHTML = '';
            data.items.forEach(i => {
                tbody.innerHTML += `<tr><td>${i.type} (${i.weight}‡∏Å‡∏Å.)</td><td style="text-align:right;">${i.total.toFixed(2)}</td></tr>`;
            });
        }

        function downloadImage() {
            const paper = document.getElementById('receipt-paper');
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡πà‡∏≤‡∏¢
            const btns = paper.querySelectorAll('button');
            btns.forEach(b => b.style.display = 'none');
            
            html2canvas(paper, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Receipt_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                btns.forEach(b => b.style.display = 'inline-block'); // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
            });
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô) ---
        function loadDashboard() {
            if(!db) return;
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (Limit 50 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)
            db.collection("transactions").orderBy("date", "desc").limit(50).get().then(snap => {
                let sales = 0, weight = 0, co2 = 0;
                // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢)
                const today = new Date().toISOString().split('T')[0];
                
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.date.startsWith(today)) {
                        sales += d.total;
                        weight += d.totalWeight || 0;
                        co2 += d.totalCo2 || 0;
                    }
                });
                
                document.getElementById('dash-sales').innerText = sales.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";
                document.getElementById('dash-weight').innerText = weight.toLocaleString();
                document.getElementById('dash-co2').innerText = co2.toFixed(2);
            });
        }

        function loadCustomers() {
            if(!db) return;
            const tbody = document.getElementById('cust-list');
            tbody.innerHTML = '<tr><td colspan="3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
            
            db.collection("customers").orderBy("totalSales", "desc").limit(20).get().then(snap => {
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    tbody.innerHTML += `<tr><td>${d.name}</td><td>${d.phone}</td><td>${d.totalSales.toLocaleString()}</td></tr>`;
                });
            });
        }

        function loadTransactions() {
            if(!db) return;
            const tbody = document.getElementById('trans-list');
            db.collection("transactions").orderBy("date", "desc").limit(20).get().then(snap => {
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = new Date(d.date).toLocaleDateString('th-TH');
                    tbody.innerHTML += `<tr><td>${date}</td><td>${d.customerName}</td><td>${d.total.toLocaleString()}</td></tr>`;
                });
            });
        }

        function exportExcel() {
            const table = document.getElementById("report-table");
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, "Report.xlsx");
        }

    </script>
</body>
</html>