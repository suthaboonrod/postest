<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ - ‡∏´‡∏°‡∏µ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏° (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°) */
        :root { --primary: #2563eb; --secondary: #64748b; --success: #10b981; --bg: #f1f5f9; --card-bg: #ffffff; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 250px; background: #1e293b; color: white; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-size: 20px; font-weight: bold; text-align: center; border-bottom: 1px solid #334155; }
        .menu-item { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: var(--primary); }
        .menu-item i { width: 25px; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stat-card { padding: 20px; border-radius: 10px; color: white; }
        .stat-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .stat-green { background: linear-gradient(135deg, #10b981, #059669); }
        .stat-orange { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .stat-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .stat-value { font-size: 28px; font-weight: bold; margin-top: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-family: 'Sarabun'; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; border: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: #ef4444; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-weight: 600; color: #475569; }
        
        /* Receipt Area */
        #receipt-area {
            background: white; padding: 40px; width: 400px; margin: auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.1); display: none;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 1000; border-radius: 0;
        }
        .rc-header { text-align: center; border-bottom: 2px solid #ddd; padding-bottom: 15px; margin-bottom: 15px; }
        .rc-total { font-size: 24px; font-weight: bold; color: var(--primary); text-align: right; margin-top: 10px; border-top: 2px solid var(--primary); padding-top: 5px;}
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; display:none;}

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; flex-direction: row; overflow-x: auto; }
            .menu-item span { display: none; }
            .grid-4 { grid-template-columns: 1fr 1fr; }
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">üêª ‡∏´‡∏°‡∏µ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á</div>
        <div class="menu-item active" onclick="showPage('dashboard')"><i class="fas fa-chart-line"></i> <span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span></div>
        <div class="menu-item" onclick="showPage('pos')"><i class="fas fa-calculator"></i> <span>‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠ (POS)</span></div>
        <div class="menu-item" onclick="showPage('customers')"><i class="fas fa-users"></i> <span>‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span></div>
        <div class="menu-item" onclick="showPage('reports')"><i class="fas fa-file-export"></i> <span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></div>
    </div>

    <div class="main-content">
        <div id="dashboard" class="page active">
            <h2>üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</h2>
            <div class="grid-4">
                <div class="stat-card stat-blue"><div class="stat-label">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div><div class="stat-value" id="dash-today-sales">0 ‡∏ø</div></div>
                <div class="stat-card stat-green"><div class="stat-label">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div><div class="stat-value" id="dash-month-sales">0 ‡∏ø</div></div>
                <div class="stat-card stat-orange"><div class="stat-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°</div><div class="stat-value" id="dash-weight">0 ‡∏Å‡∏Å.</div></div>
                <div class="stat-card stat-purple"><div class="stat-label">‡∏•‡∏î CO‚ÇÇ ‡∏™‡∏∞‡∏™‡∏°</div><div class="stat-value" id="dash-co2">0 kg</div></div>
            </div>
            <div class="grid-2" style="margin-top: 20px;">
                <div class="card"><h3>üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠</h3><canvas id="salesChart"></canvas></div>
                <div class="card"><h3>üèÜ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h3><canvas id="itemsChart"></canvas></div>
            </div>
        </div>

        <div id="pos" class="page">
            <h2>üõí ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏¢‡∏∞‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•</h2>
            <div class="grid-2">
                <div class="card">
                    <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£):</label>
                    <div style="display:flex; gap:5px;">
                        <input type="tel" id="pos-phone" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                        <button class="btn-primary" style="width:auto;" onclick="findCustomer()"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="pos-customer-name" style="color:var(--primary); font-weight:bold; margin-bottom:10px;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
                    <hr>
                    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏¢‡∏∞:</label>
                    <select id="pos-type">
                        <option value="‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏•‡∏±‡∏á">‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏•‡∏±‡∏á</option>
                        <option value="‡∏Ç‡∏ß‡∏î‡πÉ‡∏™ (PET)">‡∏Ç‡∏ß‡∏î‡πÉ‡∏™ (PET)</option>
                        <option value="‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°">‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°</option>
                        <option value="‡πÄ‡∏´‡∏•‡πá‡∏Å">‡πÄ‡∏´‡∏•‡πá‡∏Å</option>
                        <option value="‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏£‡∏ß‡∏°">‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏£‡∏ß‡∏°</option>
                        <option value="‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß">‡∏Ç‡∏ß‡∏î‡πÅ‡∏Å‡πâ‡∏ß</option>
                    </select>
                    <div class="grid-2">
                        <div><label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.):</label><input type="number" id="pos-weight" placeholder="0.0"></div>
                        <div><label>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢:</label><input type="number" id="pos-price" placeholder="0.0"></div>
                    </div>
                    <button class="btn-success" onclick="addToCart()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                </div>
                <div class="card">
                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                    <table id="cart-table">
                        <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏ô‡∏ô.</th><th>‡∏£‡∏ß‡∏°</th><th>‡∏•‡∏ö</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <div style="margin-top: 20px; text-align: right;">
                        <h3>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span id="cart-total" style="color:var(--primary);">0.00</span> ‡∏ö‡∏≤‡∏ó</h3>
                    </div>
                    <button class="btn-primary" id="btn-save-print" onclick="saveTransaction()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                </div>
            </div>
        </div>

        <div id="customers" class="page">
            <h2>üë• ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
            <div class="card">
                <input type="text" id="cust-search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." onkeyup="filterCustomers()">
                <table>
                    <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody id="customer-list"></tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="page">
            <h2>üìë ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
            <div class="card">
                <button class="btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export Excel</button>
                <div style="margin-top:20px; max-height:400px; overflow:auto;">
                    <table id="transaction-table">
                        <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
                        <tbody id="trans-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div id="receipt-area">
        <div class="close-btn" onclick="closeReceipt()">X ‡∏õ‡∏¥‡∏î</div>
        <div class="rc-header">
            <h2 style="margin:0; color:var(--primary);">‡∏´‡∏°‡∏µ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•</h2>
            <p style="margin:5px 0;">‡πÇ‡∏ó‡∏£. 081-234-5678</p>
        </div>
        <p><b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> <span id="rc-cust"></span></p>
        <p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> <span id="rc-date"></span></p>
        <hr>
        <table style="font-size:14px;">
            <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="text-align:right;">‡∏ö‡∏≤‡∏ó</th></tr></thead>
            <tbody id="rc-items"></tbody>
        </table>
        <div class="rc-total">‡∏£‡∏ß‡∏°: <span id="rc-total-val">0.00</span> ‡∏ö‡∏≤‡∏ó</div>
        <div style="text-align:center; margin-top:20px; font-size:12px; color:#777;">
            ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏£‡∏±‡∏Å‡∏©‡πå‡πÇ‡∏•‡∏Å‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤<br>"‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏¢‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏î‡∏π‡πÅ‡∏•‡πÇ‡∏•‡∏Å‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô"
        </div>
        <button class="btn-primary" style="margin-top:15px;" onclick="downloadReceipt()">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
    </div>

    <script type="module">
        // Import Firebase Library
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, increment, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
       const firebaseConfig = {
  apiKey: "AIzaSyBPKWKDSatPSVvBbpWG71Yi5-7lmret4PQ",
  authDomain: "mheerecycle.firebaseapp.com",
  projectId: "mheerecycle",
  storageBucket: "mheerecycle.firebasestorage.app",
  messagingSenderId: "1027251878904",
  appId: "1:1027251878904:web:5b4dd51fc3af8d0b6ef40d",
  measurementId: "G-DK4Z0B4H3R"
};
        // ==========================================
        const firebaseConfig = {
            // ‡∏•‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà Copy ‡∏°‡∏≤‡∏à‡∏≤‡∏Å Firebase Console ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
            // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
            // apiKey: "AIzaSyDxxxxxxxxx...",
            // authDomain: "mheerecycle.firebaseapp.com",
            // ...
        };
        // ==========================================

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
        let db;
        try {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏™‡πà Config ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            if (!firebaseConfig.apiKey) {
                alert("‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà Firebase Config ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î!\n‡πÇ‡∏õ‡∏£‡∏î‡∏ô‡∏≥‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Firebase Console ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå HTML ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 262 ‡∏Ñ‡∏£‡∏±‡∏ö");
                throw new Error("Missing Config");
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            loadDashboard(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
        } catch (e) {
            console.error("Firebase Error:", e);
            document.getElementById('btn-save-print').innerText = "‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤";
            document.getElementById('btn-save-print').style.backgroundColor = "gray";
        }

        // --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ---
        window.cart = [];
        window.currentCustomer = null;

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ---
        window.showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            // Highlight menu
            const menus = ['dashboard', 'pos', 'customers', 'reports'];
            const idx = menus.indexOf(pageId);
            if(idx >= 0) document.querySelectorAll('.menu-item')[idx].classList.add('active');
            
            if(pageId === 'customers') loadCustomers();
            if(pageId === 'reports') loadTransactions();
        };

        // --- POS Functions ---
        window.addToCart = () => {
            const type = document.getElementById('pos-type').value;
            const weight = parseFloat(document.getElementById('pos-weight').value);
            const price = parseFloat(document.getElementById('pos-price').value);

            if(!weight || !price) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            const total = weight * price;
            const co2 = weight * 1.5; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô

            window.cart.push({ type, weight, price, total, co2 });
            renderCart();
            
            document.getElementById('pos-weight').value = '';
        };

        window.renderCart = () => {
            const tbody = document.querySelector('#cart-table tbody');
            tbody.innerHTML = '';
            let sum = 0;
            window.cart.forEach((item, index) => {
                sum += item.total;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.type}</td>
                        <td>${item.weight}</td>
                        <td>${item.total.toFixed(2)}</td>
                        <td><button class="btn-danger" style="padding:5px;" onclick="delCart(${index})">X</button></td>
                    </tr>
                `;
            });
            document.getElementById('cart-total').innerText = sum.toFixed(2);
        };

        window.delCart = (index) => {
            window.cart.splice(index, 1);
            renderCart();
        };

        // --- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ---
        window.findCustomer = async () => {
            const phone = document.getElementById('pos-phone').value;
            if(!phone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
            if(!db) return alert("‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");

            try {
                const q = query(collection(db, "customers"), where("phone", "==", phone));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const docData = querySnapshot.docs[0];
                    window.currentCustomer = { id: docData.id, ...docData.data() };
                    document.getElementById('pos-customer-name').innerHTML = `<i class="fas fa-check-circle"></i> ${window.currentCustomer.name} (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤)`;
                    document.getElementById('pos-customer-name').style.color = "green";
                } else {
                    if(confirm("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏´‡∏°?")) {
                        const name = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà:");
                        if(name) {
                            const newCust = { name, phone, totalSales: 0, totalCo2: 0, joined: new Date().toISOString() };
                            const docRef = await addDoc(collection(db, "customers"), newCust);
                            window.currentCustomer = { id: docRef.id, ...newCust };
                            document.getElementById('pos-customer-name').innerText = name + " (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà)";
                            document.getElementById('pos-customer-name').style.color = "blue";
                        }
                    }
                }
            } catch (error) {
                console.error(error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: " + error.message);
            }
        };

        // --- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ---
        window.saveTransaction = async () => {
            if(window.cart.length === 0) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤");
            if(!db) return alert("‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ Config)");

            // ‡∏õ‡∏∏‡πà‡∏° Loading
            const btn = document.getElementById('btn-save-print');
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            btn.disabled = true;

            try {
                const total = window.cart.reduce((sum, item) => sum + item.total, 0);
                const totalCo2 = window.cart.reduce((sum, item) => sum + item.co2, 0);
                const totalWeight = window.cart.reduce((sum, item) => sum + item.weight, 0);

                // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Transaction
                const transaction = {
                    date: new Date().toISOString(),
                    customerId: window.currentCustomer ? window.currentCustomer.id : 'guest',
                    customerName: window.currentCustomer ? window.currentCustomer.name : '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
                    customerPhone: window.currentCustomer ? window.currentCustomer.phone : '-',
                    items: window.cart,
                    total: total,
                    totalCo2: totalCo2,
                    totalWeight: totalWeight
                };

                // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firestore
                await addDoc(collection(db, "transactions"), transaction);

                // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                if(window.currentCustomer) {
                    const custRef = doc(db, "customers", window.currentCustomer.id);
                    await updateDoc(custRef, {
                        totalSales: increment(total),
                        totalCo2: increment(totalCo2)
                    });
                }

                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                
                // 4. ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                showReceipt(transaction);
                
                // 5. ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                window.cart = [];
                window.currentCustomer = null;
                document.getElementById('pos-phone').value = '';
                document.getElementById('pos-customer-name').innerText = '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                document.getElementById('pos-customer-name').style.color = "var(--primary)";
                renderCart();
                loadDashboard(); // Refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

            } catch (error) {
                console.error("Save Error:", error);
                alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message + "\n(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Test Mode ‡πÉ‡∏ô Firebase ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á)");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // --- ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ---
        window.showReceipt = (trans) => {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('receipt-area').style.display = 'block';
            document.getElementById('rc-cust').innerText = trans.customerName;
            document.getElementById('rc-date').innerText = new Date().toLocaleString('th-TH');
            document.getElementById('rc-total-val').innerText = trans.total.toLocaleString();

            const tbody = document.getElementById('rc-items');
            tbody.innerHTML = '';
            trans.items.forEach(item => {
                tbody.innerHTML += `<tr><td>${item.type} (${item.weight}‡∏Å‡∏Å.)</td><td style="text-align:right;">${item.total.toFixed(2)}</td></tr>`;
            });
        };

        window.closeReceipt = () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('receipt-area').style.display = 'none';
        };

        window.downloadReceipt = () => {
            const rcArea = document.getElementById('receipt-area');
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            const btns = rcArea.querySelectorAll('button, .close-btn');
            btns.forEach(b => b.style.display = 'none');

            html2canvas(rcArea, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Receipt_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                btns.forEach(b => b.style.display = 'block');
            }).catch(err => {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ: " + err);
                btns.forEach(b => b.style.display = 'block');
            });
        };

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Dashboard/Customers/Report) ---
        // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å DB ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á)
        async function loadDashboard() {
            if(!db) return;
            // ‡∏î‡∏∂‡∏á 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ (‡πÉ‡∏ô Production ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥ Aggregation)
            const q = query(collection(db, "transactions"), orderBy("date", "desc"), limit(50));
            const snapshot = await getDocs(q);
            
            let todaySales = 0;
            let monthSales = 0;
            let totalWeight = 0;
            let totalCo2 = 0;
            const todayStr = new Date().toISOString().split('T')[0];

            snapshot.forEach(doc => {
                const d = doc.data();
                if(d.date.startsWith(todayStr)) todaySales += d.total;
                monthSales += d.total; 
                totalWeight += d.totalWeight || 0;
                totalCo2 += d.totalCo2 || 0;
            });

            document.getElementById('dash-today-sales').innerText = todaySales.toLocaleString() + " ‡∏ø";
            document.getElementById('dash-month-sales').innerText = monthSales.toLocaleString() + " ‡∏ø";
            document.getElementById('dash-weight').innerText = totalWeight.toLocaleString() + " ‡∏Å‡∏Å.";
            document.getElementById('dash-co2').innerText = totalCo2.toFixed(2) + " kg";
            
            // Render ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ)
            renderCharts(); 
        }

        async function loadCustomers() {
            if(!db) return;
            const tbody = document.getElementById('customer-list');
            tbody.innerHTML = "<tr><td colspan='4'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>";
            
            const q = query(collection(db, "customers"), orderBy("totalSales", "desc"), limit(20));
            const snapshot = await getDocs(q);
            tbody.innerHTML = "";

            snapshot.forEach(doc => {
                const d = doc.data();
                tbody.innerHTML += `<tr>
                    <td>${d.name}</td>
                    <td>${d.phone}</td>
                    <td>${d.totalSales.toLocaleString()} ‡∏ø</td>
                    <td><button class="btn-primary" style="padding:5px;">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></td>
                </tr>`;
            });
        }

        async function loadTransactions() {
            if(!db) return;
            const tbody = document.getElementById('trans-list');
            tbody.innerHTML = "<tr><td colspan='4'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>";

            const q = query(collection(db, "transactions"), orderBy("date", "desc"), limit(20));
            const snapshot = await getDocs(q);
            tbody.innerHTML = "";

            snapshot.forEach(doc => {
                const d = doc.data();
                const date = new Date(d.date).toLocaleString('th-TH');
                const items = d.items.map(i => i.type).join(", ");
                tbody.innerHTML += `<tr><td>${date}</td><td>${d.customerName}</td><td>${items}</td><td>${d.total.toLocaleString()}</td></tr>`;
            });
        }

        function renderCharts() {
            // (Chart Logic ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
             const ctx1 = document.getElementById('salesChart').getContext('2d');
            if(window.myChart1) window.myChart1.destroy(); // ‡∏•‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            window.myChart1 = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™', '‡∏≠‡∏≤'],
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                        data: [1200, 1900, 3000, 5000, 2000, 3000, 4500],
                        borderColor: '#2563eb',
                        tension: 0.4
                    }]
                }
            });

            const ctx2 = document.getElementById('itemsChart').getContext('2d');
             if(window.myChart2) window.myChart2.destroy();
            window.myChart2 = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©', '‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å', '‡πÇ‡∏•‡∏´‡∏∞', '‡πÅ‡∏Å‡πâ‡∏ß'],
                    datasets: [{
                        data: [30, 20, 15, 35],
                        backgroundColor: ['#f59e0b', '#3b82f6', '#ef4444', '#10b981']
                    }]
                }
            });
        }
        
        // Export Excel
        window.exportToExcel = () => {
            const table = document.getElementById("transaction-table");
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, "Report.xlsx");
        }
        
        // Filter
        window.filterCustomers = () => {
            const input = document.getElementById("cust-search");
            const filter = input.value.toUpperCase();
            const table = document.getElementById("customer-list");
            const tr = table.getElementsByTagName("tr");
            for (let i = 0; i < tr.length; i++) {
                const tdName = tr[i].getElementsByTagName("td")[0];
                const tdPhone = tr[i].getElementsByTagName("td")[1];
                if (tdName || tdPhone) {
                    const txtValueName = tdName.textContent || tdName.innerText;
                    const txtValuePhone = tdPhone.textContent || tdPhone.innerText;
                    if (txtValueName.toUpperCase().indexOf(filter) > -1 || txtValuePhone.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

    </script>
</body>
</html>